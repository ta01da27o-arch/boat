name: Train and Predict (Boat Race AI)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *"  # JST 07:00 å®Ÿè¡Œ

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ===============================
      # ğŸ§­ ãƒ‡ãƒ¼ã‚¿å–å¾— (ç›´è¿‘60æ—¥åˆ†)
      # ===============================
      - name: ğŸ“… Fetch latest and historical race data
        run: |
          echo "ğŸ“… Fetching 60 days of race data..."
          python fetch_data.py
          echo "âœ… Data fetch completed."

      # ===============================
      # ğŸ§© ç‰¹å¾´é‡ç”Ÿæˆ
      # ===============================
      - name: ğŸ§© Generate features
        run: |
          echo "ğŸ§© Generating features..."
          python features.py || echo "[WARN] ç‰¹å¾´é‡ç”Ÿæˆã«å¤±æ•—ã¾ãŸã¯ç©ºãƒ‡ãƒ¼ã‚¿ã€‚"
          ls -lh | grep features || echo "âš  features.csv ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"

      # ===============================
      # ğŸ¤– ãƒ¢ãƒ‡ãƒ«å­¦ç¿’
      # ===============================
      - name: ğŸ¤– Train AI model
        run: |
          echo "ğŸ¤– Training model..."
          if [ -f "features.csv" ]; then
            python train_model.py
          else
            echo "âš  features.csv ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€å­¦ç¿’ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi

      # ===============================
      # ğŸ—ƒï¸ ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª
      # ===============================
      - name: ğŸ“ Check generated files
        run: |
          echo "ğŸ“ Files generated:"
          ls -lh data/ || echo "âš  data ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          ls -lh | grep .pkl || echo "âš  ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

      # ===============================
      # ğŸª¶ GitHubã¸ã‚³ãƒŸãƒƒãƒˆ
      # ===============================
      - name: ğŸ’¾ Commit and push updates
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          git add data/*.json || true
          git add features.csv || true
          git add model.pkl || true
          
          git commit -m "Auto-update: data, features, and model [$(date '+%Y-%m-%d %H:%M')]" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: âœ… Done
        run: echo "âœ… All steps completed successfully!"
