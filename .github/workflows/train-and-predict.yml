name: Train and Predict (Boat Race AI)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *"  # JST 07:00 実行

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      - name: 🚀 Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ===============================
      # 🧭 データ取得 (直近60日分)
      # ===============================
      - name: 📅 Fetch latest and historical race data
        run: |
          echo "📅 Fetching 60 days of race data..."
          python fetch_data.py
          echo "✅ Data fetch completed."

      # ===============================
      # 🧩 特徴量生成
      # ===============================
      - name: 🧩 Generate features
        run: |
          echo "🧩 Generating features..."
          python features.py || echo "[WARN] 特徴量生成に失敗または空データ。"
          ls -lh | grep features || echo "⚠ features.csv が生成されませんでした。"

      # ===============================
      # 🤖 モデル学習
      # ===============================
      - name: 🤖 Train AI model
        run: |
          echo "🤖 Training model..."
          if [ -f "features.csv" ]; then
            python train_model.py
          else
            echo "⚠ features.csv が存在しないため、学習をスキップします。"
          fi

      # ===============================
      # 🗃️ 生成ファイル確認
      # ===============================
      - name: 📁 Check generated files
        run: |
          echo "📁 Files generated:"
          ls -lh data/ || echo "⚠ data フォルダが存在しません"
          ls -lh | grep .pkl || echo "⚠ モデルファイルが見つかりません"

      # ===============================
      # 🪶 GitHubへコミット
      # ===============================
      - name: 💾 Commit and push updates
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          git add data/*.json || true
          git add features.csv || true
          git add model.pkl || true
          
          git commit -m "Auto-update: data, features, and model [$(date '+%Y-%m-%d %H:%M')]" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: ✅ Done
        run: echo "✅ All steps completed successfully!"
