name: Fetch Boat Race Data (JSTå¯¾å¿œãƒ»ã‚¹ãƒãƒ¼ãƒˆå†è©¦è¡Œç‰ˆ)

on:
  schedule:
    # æ¯æ—¥ æ—¥æœ¬æ™‚é–“ æœ7:00 ã«è‡ªå‹•å®Ÿè¡Œï¼ˆUTC 22:00ï¼‰
    - cron: "0 22 * * *"
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯¾å¿œ

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml pytz

      # â–¼ ã‚¹ãƒãƒ¼ãƒˆå†è©¦è¡Œé–¢æ•°å®šç¾©
      - name: Define retry function
        run: |
          echo '#!/bin/bash' > retry.sh
          echo 'set -e' >> retry.sh
          echo 'cmd="$1"' >> retry.sh
          echo 'max_attempts=${2:-3}' >> retry.sh
          echo 'wait_seconds=${3:-900}' >> retry.sh
          echo 'attempt=1' >> retry.sh
          echo 'while true; do' >> retry.sh
          echo '  echo "ğŸ”„ Attempt $attempt/$max_attempts: $cmd"' >> retry.sh
          echo '  if eval "$cmd"; then' >> retry.sh
          echo '    echo "âœ… æˆåŠŸã—ã¾ã—ãŸã€‚"' >> retry.sh
          echo '    break' >> retry.sh
          echo '  fi' >> retry.sh
          echo '  if [ $attempt -ge $max_attempts ]; then' >> retry.sh
          echo '    echo "âŒ æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸã€‚çµ‚äº†ã—ã¾ã™ã€‚"' >> retry.sh
          echo '    exit 1' >> retry.sh
          echo '  fi' >> retry.sh
          echo '  attempt=$((attempt+1))' >> retry.sh
          echo '  echo "â³ ${wait_seconds}ç§’å¾Œã«å†è©¦è¡Œ..."' >> retry.sh
          echo '  sleep $wait_seconds' >> retry.sh
          echo 'done' >> retry.sh
          chmod +x retry.sh

      # â–¼ å‡ºèµ°è¡¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆæœ€å¤§3å›ãƒ»15åˆ†é–“éš”ï¼‰
      - name: Fetch Program (å‡ºèµ°è¡¨ãƒ»ã‚¹ãƒãƒ¼ãƒˆå†è©¦è¡Œ)
        run: |
          ./retry.sh "python fetch_data.py --force-program" 3 900

      # â–¼ çµæœãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆæœ€å¤§3å›ãƒ»15åˆ†é–“éš”ï¼‰
      - name: Fetch Result (çµæœãƒ»ã‚¹ãƒãƒ¼ãƒˆå†è©¦è¡Œ)
        run: |
          ./retry.sh "python fetch_data.py --force-result" 3 900

      # â–¼ data.json ã®å†…å®¹ã‚’ç¢ºèª
      - name: Show data.json preview
        run: |
          echo "=== data.json preview (first 50 lines) ==="
          head -n 50 data.json || echo "data.json not found"

      # â–¼ å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit and push if changed
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          if git diff --cached --quiet; then
            echo "âœ… No changes detected â€” skipping commit."
          else
            git commit -m "Update data.json (Auto JST fetch with retry)"
            git push
            echo "ğŸš€ Changes pushed to main."
          fi