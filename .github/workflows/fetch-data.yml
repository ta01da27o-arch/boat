name: Fetch Boat Race Data

on:
  workflow_dispatch:        # æ‰‹å‹•å®Ÿè¡Œ
  schedule:
    - cron: "0 23 * * *"    # JST 08:00 (GitHubã¯UTCåŸºæº–ã§23:00å®Ÿè¡Œ)

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # ------------------------------
      # â‘  GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’å–å¾—
      # ------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------
      # â‘¡ Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ------------------------------
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ------------------------------
      # â‘¢ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # ------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      # ------------------------------
      # â‘£ è‡ªå‹•æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
      # ------------------------------
      - name: Run fetch_data.py
        run: |
          echo "ğŸš€ Render è‡ªå‹•æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆé–‹å§‹"
          python fetch_data.py || exit 1

      # ------------------------------
      # â‘¤ å®Ÿè¡Œçµæœã‚’ç¢ºèª
      # ------------------------------
      - name: Check generated files
        run: |
          echo "ğŸ§© data.json:"
          head -n 20 data/data.json || true
          echo "ğŸ§  history.json:"
          head -n 20 data/history.json || true

      # ------------------------------
      # â‘¥ GitHubã«ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
      # ------------------------------
      - name: Commit and push if changed
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          git add data/data.json data/history.json || true
          if git diff --cached --quiet; then
            echo "âœ… å¤‰æ›´ãªã—ã€‚ã‚³ãƒŸãƒƒãƒˆã‚¹ã‚­ãƒƒãƒ—ã€‚"
          else
            git commit -m "Auto Update: $(date '+%Y-%m-%d %H:%M')"
            git push
            echo "ğŸ“¤ data.json, history.json ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚"
          fi

      # ------------------------------
      # â‘¦ å®Ÿè¡Œå®Œäº†ãƒ­ã‚°
      # ------------------------------
      - name: Finish log
        run: |
          echo "ğŸ¯ å®Œäº†æ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')"