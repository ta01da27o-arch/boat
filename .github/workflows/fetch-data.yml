name: Fetch Boat Race Data

on:
  workflow_dispatch:        # 手動実行
  schedule:
    - cron: "0 23 * * *"    # JST 08:00 (GitHubはUTC基準で23:00実行)

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # ------------------------------
      # ① GitHubリポジトリを取得
      # ------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------
      # ② Pythonセットアップ
      # ------------------------------
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ------------------------------
      # ③ 依存パッケージをインストール
      # ------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      # ------------------------------
      # ④ 自動更新スクリプト実行
      # ------------------------------
      - name: Run fetch_data.py
        run: |
          echo "🚀 Render 自動更新スクリプト開始"
          python fetch_data.py || exit 1

      # ------------------------------
      # ⑤ 実行結果を確認
      # ------------------------------
      - name: Check generated files
        run: |
          echo "🧩 data.json:"
          head -n 20 data/data.json || true
          echo "🧠 history.json:"
          head -n 20 data/history.json || true

      # ------------------------------
      # ⑥ GitHubにコミット＆プッシュ
      # ------------------------------
      - name: Commit and push if changed
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          git add data/data.json data/history.json || true
          if git diff --cached --quiet; then
            echo "✅ 変更なし。コミットスキップ。"
          else
            git commit -m "Auto Update: $(date '+%Y-%m-%d %H:%M')"
            git push
            echo "📤 data.json, history.json を更新しました。"
          fi

      # ------------------------------
      # ⑦ 実行完了ログ
      # ------------------------------
      - name: Finish log
        run: |
          echo "🎯 完了日時: $(date '+%Y-%m-%d %H:%M:%S')"